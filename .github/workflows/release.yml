name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    strategy:
      matrix:
        include:
          - os: macos-latest
            arch: aarch64  # Apple Silicon
          # å¦‚æœéœ€è¦æ”¯æŒ Intel Macï¼Œå–æ¶ˆæ³¨é‡Šä¸‹é¢ä¸¤è¡Œ
          # - os: macos-13
          #   arch: x86_64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.arch }}-apple-darwin

      - name: Install dependencies
        run: npm ci

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build Tauri app
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Rename macOS artifacts
        run: |
          # Rename DMG files from "SDKMAN GUI" to "sdkman-gui"
          for file in src-tauri/target/release/bundle/dmg/SDKMAN\ GUI*.dmg; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed 's/SDKMAN GUI/sdkman-gui/g')
              mv "$file" "$newname"
              echo "Renamed: $(basename "$newname")"
            fi
          done

      - name: Prepare macOS artifacts
        id: prepare
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„ DMG æ–‡ä»¶
          DMG_FILE=$(find src-tauri/target/release/bundle/dmg -name "*.dmg" | head -n 1)

          if [ -z "$DMG_FILE" ]; then
            echo "Error: DMG file not found"
            exit 1
          fi

          # è®¡ç®— SHA256
          SHA256=$(shasum -a 256 "$DMG_FILE" | awk '{print $1}')
          BASENAME=$(basename "$DMG_FILE")

          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "dmg_file=$DMG_FILE" >> $GITHUB_OUTPUT
          echo "basename=$BASENAME" >> $GITHUB_OUTPUT
          echo "SHA256 ($BASENAME): $SHA256"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: ${{ steps.prepare.outputs.dmg_file }}
          retention-days: 1
          compression-level: 0

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install dependencies
        run: npm ci

      - name: Get version from tag
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build Tauri app
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Rename Windows artifacts
        shell: bash
        run: |
          # Rename MSI files from "SDKMAN GUI" to "sdkman-gui" and remove language suffix
          for file in src-tauri/target/release/bundle/msi/SDKMAN\ GUI*.msi; do
            if [ -f "$file" ]; then
              # Remove "SDKMAN GUI" and language suffix like "_en-US" or "_x64_en-US"
              newname=$(echo "$file" | sed 's/SDKMAN GUI/sdkman-gui/g' | sed 's/_en-US//g')
              mv "$file" "$newname"
              echo "Renamed: $(basename "$newname")"
            fi
          done

      - name: Prepare Windows artifacts
        id: prepare
        shell: bash
        run: |
          # æŸ¥æ‰¾ MSI æ–‡ä»¶
          MSI_FILE=$(find src-tauri/target/release/bundle/msi -name "*.msi" 2>/dev/null | head -n 1)

          if [ -z "$MSI_FILE" ]; then
            echo "Error: MSI file not found"
            exit 1
          fi

          SHA256=$(powershell -Command "Get-FileHash -Algorithm SHA256 '$MSI_FILE' | Select-Object -ExpandProperty Hash" | tr '[:upper:]' '[:lower:]')
          BASENAME=$(basename "$MSI_FILE")
          echo "msi_file=$MSI_FILE" >> $GITHUB_OUTPUT
          echo "msi_basename=$BASENAME" >> $GITHUB_OUTPUT
          echo "msi_sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "MSI SHA256 ($BASENAME): $SHA256"

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: ${{ steps.prepare.outputs.msi_file }}
          retention-days: 1
          compression-level: 0

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install dependencies
        run: npm ci

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build Tauri app
        run: npm run tauri build

      - name: Rename Linux artifacts
        run: |
          # Rename DEB files from "SDKMAN GUI" to "sdkman-gui"
          for file in src-tauri/target/release/bundle/deb/SDKMAN\ GUI*.deb; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed 's/SDKMAN GUI/sdkman-gui/g')
              mv "$file" "$newname"
              echo "Renamed: $(basename "$newname")"
            fi
          done

          # Rename RPM files from "SDKMAN GUI" to "sdkman-gui"
          for file in src-tauri/target/release/bundle/rpm/SDKMAN\ GUI*.rpm; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed 's/SDKMAN GUI/sdkman-gui/g')
              mv "$file" "$newname"
              echo "Renamed: $(basename "$newname")"
            fi
          done

      - name: Prepare Linux artifacts
        id: prepare
        run: |
          # æŸ¥æ‰¾ DEB æ–‡ä»¶
          DEB_FILE=$(ls src-tauri/target/release/bundle/deb/*.deb 2>/dev/null | head -n 1)

          # æŸ¥æ‰¾ RPM æ–‡ä»¶
          RPM_FILE=$(ls src-tauri/target/release/bundle/rpm/*.rpm 2>/dev/null | head -n 1)

          if [ -z "$DEB_FILE" ] && [ -z "$RPM_FILE" ]; then
            echo "Error: No DEB or RPM files found"
            exit 1
          fi

          if [ -n "$DEB_FILE" ]; then
            DEB_SHA256=$(sha256sum "$DEB_FILE" | awk '{print $1}')
            DEB_BASENAME=$(basename "$DEB_FILE")
            echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT
            echo "deb_basename=$DEB_BASENAME" >> $GITHUB_OUTPUT
            echo "deb_sha256=$DEB_SHA256" >> $GITHUB_OUTPUT
            echo "DEB SHA256 ($DEB_BASENAME): $DEB_SHA256"
          fi

          if [ -n "$RPM_FILE" ]; then
            RPM_SHA256=$(sha256sum "$RPM_FILE" | awk '{print $1}')
            RPM_BASENAME=$(basename "$RPM_FILE")
            echo "rpm_file=$RPM_FILE" >> $GITHUB_OUTPUT
            echo "rpm_basename=$RPM_BASENAME" >> $GITHUB_OUTPUT
            echo "rpm_sha256=$RPM_SHA256" >> $GITHUB_OUTPUT
            echo "RPM SHA256 ($RPM_BASENAME): $RPM_SHA256"
          fi

      - name: Upload DEB artifact
        if: steps.prepare.outputs.deb_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: ${{ steps.prepare.outputs.deb_file }}
          retention-days: 1
          compression-level: 0

      - name: Upload RPM artifact
        if: steps.prepare.outputs.rpm_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: ${{ steps.prepare.outputs.rpm_file }}
          retention-days: 1
          compression-level: 0

  create-release:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded files
        run: |
          echo "Downloaded files:"
          ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## âœ¨ Features

            - ğŸ¨ **Modern UI** - Beautiful Tauri-based native interface
            - ğŸŒ **Internationalization** - Support for English and Chinese with automatic system language detection
            - ğŸŒ— **Theme Switching** - Support for light/dark/auto themes
            - ğŸ“¦ **JDK Management** - Browse, install, uninstall, and switch JDK versions
            - ğŸ› ï¸ **SDK Management** - Manage various development SDKs
            - ğŸ” **Search & Filter** - Quickly find the JDKs and SDKs you need
            - ğŸ·ï¸ **Category Browsing** - View SDKs by category
            - âš™ï¸ **Configuration Management** - Flexible application configuration with proxy support

            ## âœ¨ ç‰¹æ€§

            - ğŸ¨ **ç°ä»£åŒ–UI** - åŸºäºTauriçš„ç²¾ç¾åŸç”Ÿç•Œé¢
            - ğŸŒ **å›½é™…åŒ–æ”¯æŒ** - æ”¯æŒä¸­è‹±æ–‡ï¼Œè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿè¯­è¨€
            - ğŸŒ— **ä¸»é¢˜åˆ‡æ¢** - æ”¯æŒäº®è‰²/æš—è‰²/è‡ªåŠ¨ä¸»é¢˜
            - ğŸ“¦ **JDKç®¡ç†** - æµè§ˆã€å®‰è£…ã€å¸è½½ã€åˆ‡æ¢JDKç‰ˆæœ¬
            - ğŸ› ï¸ **SDKç®¡ç†** - ç®¡ç†å„ç§å¼€å‘å·¥å…·SDK
            - ğŸ” **æœç´¢è¿‡æ»¤** - å¿«é€ŸæŸ¥æ‰¾æ‰€éœ€çš„JDKå’ŒSDK
            - ğŸ·ï¸ **åˆ†ç±»æµè§ˆ** - æŒ‰ç±»åˆ«æŸ¥çœ‹SDK
            - âš™ï¸ **é…ç½®ç®¡ç†** - çµæ´»çš„åº”ç”¨é…ç½®ï¼Œæ”¯æŒä»£ç†è®¾ç½®

            ---

            ### ğŸ“¦ Installation

            #### macOS

            - Download the DMG file for your architecture
            - Open the DMG and drag the app to Applications folder
            - **Important**: If you see "app is damaged" error, run:
              ```bash
              xattr -cr /Applications/SDKMAN\ GUI.app
              ```

            #### Windows

            - Download the `.msi` file
            - Double-click to install

            #### Linux

            **Debian/Ubuntu (.deb):**
            ```bash
            # Download the .deb file, then:
            sudo dpkg -i sdkman-gui_${{ steps.get_version.outputs.VERSION }}_amd64.deb
            # If dependencies missing:
            sudo apt-get install -f
            ```

            **Red Hat/Fedora (.rpm):**
            ```bash
            # Fedora/RHEL 8+:
            sudo dnf install sdkman-gui-${{ steps.get_version.outputs.VERSION }}-1.x86_64.rpm

            # Or RHEL 7/CentOS:
            sudo yum install sdkman-gui-${{ steps.get_version.outputs.VERSION }}-1.x86_64.rpm
            ```

            ---

            ### âš ï¸ Prerequisites

            **SDKMAN must be installed first:**
            ```bash
            curl -s "https://get.sdkman.io" | bash
            ```

            ### ğŸ“‹ Supported Platforms

            - **macOS**: Monterey (12.0) or later (Apple Silicon)
            - **Windows**: Windows 10/11 (x64)
            - **Linux**: Debian/Ubuntu (.deb) and Red Hat/Fedora (.rpm)

          files: |
            artifacts/**/*.dmg
            artifacts/**/*.msi
            artifacts/**/*.deb
            artifacts/**/*.rpm
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
